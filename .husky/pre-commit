#!/usr/bin/env sh

# Pre-commit hook for block theme scaffold
# Intelligently handles both scaffold mode and generated theme mode
# Runs linting and tests before allowing commits

. "$(dirname -- "$0")/_/husky.sh"

# Check if we're in scaffold mode (has mustache variables)
if node scripts/test-placeholders.js check package.json 2>/dev/null; then
    echo "ğŸ” Scaffold mode detected - using dry-run linting and testing..."
    echo ""

    # Run lint dry-run which handles mustache variables
    npm run lint:dry-run || {
        echo ""
        echo "âŒ Lint dry-run failed. Please fix the issues and try again."
        echo "ğŸ’¡ Tip: Run 'npm run lint:dry-run' to see all issues"
        echo "ğŸ’¡ To bypass this check (not recommended), use: git commit --no-verify"
        exit 1
    }

    # Run test dry-run which handles mustache variables
    echo ""
    echo "ğŸ§ª Running tests with dry-run..."
    npm run test:dry-run || {
        echo ""
        echo "âŒ Test dry-run failed. Please fix the failing tests and try again."
        echo "ğŸ’¡ Tip: Run 'npm run test:dry-run' to see all test failures"
        echo "ğŸ’¡ To bypass this check (not recommended), use: git commit --no-verify"
        exit 1
    }

    echo ""
    echo "âœ… All scaffold pre-commit checks passed!"

else
    echo "ğŸ” Generated theme mode detected - running standard linting and testing..."
    echo ""

    # Standard linting for generated themes
    echo "ğŸŸ¡ Linting JavaScript..."
    npm run lint:js || {
        echo "âŒ JavaScript linting failed. Please fix the issues and try again."
        echo "ğŸ’¡ Tip: Run 'npm run lint:js:fix' to auto-fix many issues"
        exit 1
    }

    echo "ğŸŸ¡ Linting CSS..."
    npm run lint:css || {
        echo "âŒ CSS linting failed. Please fix the issues and try again."
        echo "ğŸ’¡ Tip: Run 'npm run lint:css:fix' to auto-fix many issues"
        exit 1
    }

    # Run PHP linting (if composer is available)
    if command -v composer > /dev/null 2>&1; then
        echo "ğŸŸ¡ Linting PHP..."
        composer run lint || {
            echo "âŒ PHP linting failed. Please fix the issues and try again."
            echo "ğŸ’¡ Tip: Run 'composer run lint:fix' to auto-fix many issues"
            exit 1
        }
    else
        echo "âš ï¸  Skipping PHP linting (Composer not available)"
    fi

    # Run all tests
    echo ""
    echo "ğŸ§ª Running JavaScript tests..."
    npm run test:js -- --bail || {
        echo "âŒ JavaScript tests failed. Please fix the failing tests and try again."
        echo "ğŸ’¡ Tip: Run 'npm run test:js' to see all test failures"
        exit 1
    }

    if command -v composer > /dev/null 2>&1; then
        echo "ğŸ§ª Running PHP tests..."
        npm run test:php || {
            echo "âŒ PHP tests failed. Please fix the failing tests and try again."
            echo "ğŸ’¡ Tip: Run 'npm run test:php' to see all test failures"
            exit 1
        }
    else
        echo "âš ï¸  Skipping PHP tests (Composer not available)"
    fi

    # Run security audit
    echo ""
    echo "ğŸ”’ Running security audit..."
    npm audit --audit-level=high --production || {
        echo "âš ï¸  Security vulnerabilities detected (high or critical)."
        echo "ğŸ’¡ Run 'npm audit' for details or 'npm audit fix' to attempt automatic fixes."
        echo "ğŸ’¡ To bypass this check (not recommended), use: git commit --no-verify"
        exit 1
    }

    echo ""
    echo "âœ… All pre-commit checks passed!"
fi

